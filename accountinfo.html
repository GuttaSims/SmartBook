<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Account Info</title>
    <link rel="stylesheet" href="style.css">
    <style>
        body {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: auto; /* Allow body to grow based on content */
            background-color: #f0f0f0;
            font-family: Arial, sans-serif;
            text-align: center;
            padding: 20px; /* Add padding for mobile */
        }
        h1 {
            background: linear-gradient(145deg, #6a82fb, #fc5c7d);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 20px;
        }
        .container {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            width: 100%; /* Full width on mobile */
            max-width: 400px; /* Max width for larger screens */
            margin-bottom: 20px;
        }
        .input-field {
            margin: 10px 0;
            padding: 10px;
            border: 2px solid #ccc;
            border-radius: 5px;
            width: calc(100% - 20px); /* Fit in container */
            font-size: 16px;
            transition: border 0.3s;
        }
        .input-field.error {
            border: 2px solid red; /* Red border for errors */
        }
        .submit-btn, .delete-btn, .back-home-btn {
            background: linear-gradient(145deg, #6a82fb, #fc5c7d);
            border: none;
            border-radius: 10px;
            padding: 15px 30px;
            color: #fff;
            font-size: 18px;
            cursor: pointer;
            width: 100%;
            transition: transform 0.3s, box-shadow 0.3s;
            margin-top: 10px; /* Space between buttons */
        }
        .submit-btn:hover, .delete-btn:hover, .back-home-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(106, 130, 251, 0.6), 
                        0 0 30px rgba(252, 92, 125, 0.9);
        }
        .success-message, .error-message {
            font-size: 14px;
            margin-top: 10px;
        }
        .success-message {
            color: green;
            background: linear-gradient(145deg, #6a82fb, #fc5c7d);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .error-message {
            color: red;
        }
        /* Media Queries for Mobile */
        @media (max-width: 480px) {
            .container {
                width: 95%; /* Slightly smaller for mobile */
                padding: 15px; /* Less padding on mobile */
            }
            .input-field {
                font-size: 14px; /* Smaller text for mobile */
            }
            .submit-btn, .delete-btn, .back-home-btn {
                font-size: 16px; /* Adjust button text size */
            }
        }
        /* Popup Styles */
        .popup {
            display: none; /* Hidden by default */
            position: fixed;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5); /* Dark background */
            justify-content: center;
            align-items: center;
            z-index: 1000; /* On top of other elements */
        }
        .popup-content {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            text-align: center;
        }
        .popup-button {
            margin: 10px;
        }
    </style>
</head>
<body>
    <h1>Account Info</h1>

    <div class="container">
        <div>
            <label for="firstName">First Name:</label>
            <div id="firstName" class="input-field" readonly></div>
        </div>
        <div>
            <label for="lastName">Last Name:</label>
            <div id="lastName" class="input-field" readonly></div>
        </div>
        <div>
            <label for="username">Username:</label>
            <input type="text" id="username" class="input-field" placeholder="Username" required>
        </div>
        <div>
            <label for="email">Email:</label>
            <input type="email" id="email" class="input-field" placeholder="Email" required>
        </div>
        <button id="updateInfo" class="submit-btn">Update Info</button>
        <div class="success-message" id="updateSuccess" style="display: none;">Update Complete</div>
        <div class="error-message" id="updateError" style="display: none;"></div>
    </div>

    <div class="container">
        <h2>Change Password</h2>
        <div>
            <label for="currentPassword">Current Password:</label>
            <input type="password" id="currentPassword" class="input-field" placeholder="Current Password" required>
        </div>
        <div>
            <label for="newPassword">New Password:</label>
            <input type="password" id="newPassword" class="input-field" placeholder="New Password" required>
        </div>
        <div>
            <label for="confirmPassword">Confirm New Password:</label>
            <input type="password" id="confirmPassword" class="input-field" placeholder="Confirm New Password" required>
        </div>
        <button id="changePassword" class="submit-btn">Change Password</button>
        <div class="success-message" id="passwordChangeSuccess" style="display: none;">Password Changed Successfully</div>
        <div class="error-message" id="passwordChangeError" style="display: none;"></div>
    </div>

    <button id="deleteAccount" class="delete-btn">Delete Account</button>
    <button id="backHome" class="back-home-btn">Back To Home</button>

    <!-- Popup for Delete Confirmation -->
    <div id="deletePopup" class="popup">
        <div class="popup-content">
            <p>Are you sure you want to delete your account?</p>
            <button id="confirmDelete" class="popup-button delete-btn">Yes</button>
            <button id="cancelDelete" class="popup-button back-home-btn">No, Cancel</button>
        </div>
    </div>

    <script type="module">
        import { getDatabase, ref, get, set, remove } from "https://www.gstatic.com/firebasejs/9.16.0/firebase-database.js";
        import { getAuth, updatePassword } from "https://www.gstatic.com/firebasejs/9.16.0/firebase-auth.js";
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.16.0/firebase-app.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAdH4k_ECww3nz9g9m32GFdBVkddabBVoc",
            authDomain: "smartbook-2215.firebaseapp.com",
            databaseURL: "https://smartbook-2215-default-rtdb.firebaseio.com/",
            projectId: "smartbook-2215",
            storageBucket: "smartbook-2215.appspot.com",
            messagingSenderId: "999113949935",
            appId: "1:999113949935:web:97d7d78e7ccf3f1b68911a"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);

        // Fetch user info and display it
        const userId = auth.currentUser ? auth.currentUser.uid : null;
        if (userId) {
            const userRef = ref(db, 'users/' + userId);

            get(userRef).then((snapshot) => {
                if (snapshot.exists()) {
                    const userData = snapshot.val();
                    document.getElementById('firstName').innerText = userData.firstName;
                    document.getElementById('lastName').innerText = userData.lastName;
                    document.getElementById('username').value = userData.username;
                    document.getElementById('email').value = userData.email;
                } else {
                    console.log("No user data available");
                }
            }).catch((error) => {
                console.error("Error fetching user data:", error);
            });
        }

        // Update Info
        document.getElementById('updateInfo').addEventListener('click', () => {
            const username = document.getElementById('username').value;
            const email = document.getElementById('email').value;
            const updateSuccess = document.getElementById('updateSuccess');
            const updateError = document.getElementById('updateError');
            updateError.style.display = "none";
            updateSuccess.style.display = "none";

            // Validate fields
            if (!username || !email) {
                if (!username) {
                    document.getElementById('username').classList.add('error');
                }
                if (!email) {
                    document.getElementById('email').classList.add('error');
                }
                updateError.innerText = "Field Required";
                updateError.style.display = "block";
                return;
            } else {
                document.getElementById('username').classList.remove('error');
                document.getElementById('email').classList.remove('error');
            }

            // Update user info in database
            set(ref(db, 'users/' + userId), {
                username: username,
                email: email,
                firstName: document.getElementById('firstName').innerText,
                lastName: document.getElementById('lastName').innerText
            }).then(() => {
                updateSuccess.style.display = "block";
                setTimeout(() => {
                    window.location.href = "index.html"; // Redirect to home page
                }, 2000);
            }).catch((error) => {
                console.error("Error updating user data:", error);
                updateError.innerText = "Update Failed. Please try again.";
                updateError.style.display = "block";
            });
        });

        // Change Password
        document.getElementById('changePassword').addEventListener('click', () => {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const passwordChangeSuccess = document.getElementById('passwordChangeSuccess');
            const passwordChangeError = document.getElementById('passwordChangeError');
            passwordChangeSuccess.style.display = "none";
            passwordChangeError.style.display = "none";

            // Validate fields
            if (!currentPassword || !newPassword || !confirmPassword) {
                if (!currentPassword) {
                    document.getElementById('currentPassword').classList.add('error');
                }
                if (!newPassword) {
                    document.getElementById('newPassword').classList.add('error');
                }
                if (!confirmPassword) {
                    document.getElementById('confirmPassword').classList.add('error');
                }
                passwordChangeError.innerText = "Field Required";
                passwordChangeError.style.display = "block";
                return;
            } else {
                document.getElementById('currentPassword').classList.remove('error');
                document.getElementById('newPassword').classList.remove('error');
                document.getElementById('confirmPassword').classList.remove('error');
            }

            if (newPassword !== confirmPassword) {
                passwordChangeError.innerText = "Passwords do not match.";
                passwordChangeError.style.display = "block";
                return;
            }

            updatePassword(auth.currentUser, newPassword).then(() => {
                passwordChangeSuccess.style.display = "block";
                setTimeout(() => {
                    window.location.href = "index.html"; // Redirect to home page
                }, 2000);
            }).catch((error) => {
                console.error("Error changing password:", error);
                passwordChangeError.innerText = "Password Change Failed. Please try again.";
                passwordChangeError.style.display = "block";
            });
        });

        // Delete Account
        document.getElementById('deleteAccount').addEventListener('click', () => {
            console.log("Delete Account button clicked."); // Debug log
            document.getElementById('deletePopup').style.display = 'flex';
        });

        document.getElementById('confirmDelete').addEventListener('click', () => {
            const user = auth.currentUser;
            if (user) {
                remove(ref(db, 'users/' + user.uid)).then(() => {
                    console.log("User data deleted from database."); // Debug log
                    // Delete user from Firebase Authentication
                    user.delete().then(() => {
                        window.location.href = "signup.html"; // Redirect to signup page
                    }).catch((error) => {
                        console.error("Error deleting user:", error);
                    });
                }).catch((error) => {
                    console.error("Error deleting user data:", error);
                });
            }
        });

        document.getElementById('cancelDelete').addEventListener('click', () => {
            console.log("Cancel Delete button clicked."); // Debug log
            document.getElementById('deletePopup').style.display = 'none';
        });

        // Back to Home
        document.getElementById('backHome').addEventListener('click', () => {
            window.location.href = "index.html";
        });
    </script>
</body>
</html>